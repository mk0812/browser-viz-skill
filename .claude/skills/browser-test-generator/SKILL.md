---
name: browser-test-generator
description: Generate browser automation test scripts (.mjs) for agent-browser with GIF recording and screenshot capture. Use when the user wants to create automated browser tests with visual documentation.
---

# browser-test-generator

agent-browserを使用したブラウザ自動化テストスクリプト（.mjs）を生成するツール。GIF録画とスクリーンショットキャプチャを含む視覚的なテストドキュメントを作成します。

## 機能

- テスト計画からmjsスクリプトを自動生成
- agent-browser CLIを使用したブラウザ操作
- GIF録画による操作フローの記録
- スクリーンショット + アノテーション（赤枠、ズーム）
- ffmpegによる高品質GIF生成

## Prerequisites

- [agent-browser](https://github.com/vercel-labs/agent-browser) がインストールされていること
- ffmpegがインストールされていること（`brew install ffmpeg`）
- Node.js 18+

## テスト計画のフォーマット

テスト計画は以下の形式で記述します：

```yaml
test_name: "タスク追加テスト"
description: "新しいタスクを追加する操作のテスト"
url: "http://localhost:5173"
steps:
  - action: "screenshot"
    name: "initial"
    description: "初期状態"
  - action: "click"
    target: "@e5"
    description: "タイトル入力欄をクリック"
  - action: "type"
    target: "@e5"
    text: "テストタスク"
    description: "タイトルを入力"
  - action: "screenshot"
    name: "after-input"
    highlight: "@e5"
    description: "入力後の状態（入力欄をハイライト）"
  - action: "click"
    target: "@e7"
    description: "追加ボタンをクリック"
  - action: "wait"
    time: 500
  - action: "screenshot"
    name: "result"
    description: "結果確認"
output:
  gif: true
  gif_name: "add-task-flow.gif"
  screenshots_dir: "./test-output"
```

## 生成されるmjsスクリプトの構造

```javascript
/**
 * Test: タスク追加テスト
 * Description: 新しいタスクを追加する操作のテスト
 * Generated by browser-test-generator
 */
import { spawn } from 'child_process';
import { mkdir } from 'fs/promises';

const TEST_NAME = 'add-task';
const OUTPUT_DIR = './test-output';
const FRAMES_DIR = `${OUTPUT_DIR}/${TEST_NAME}-frames`;

// Helper functions
async function agentBrowser(command, args = []) { ... }
async function screenshot(name) { ... }
async function sleep(ms) { ... }
async function generateGif(framesDir, outputName, fps = 3) { ... }

// Main test
async function main() {
  await mkdir(FRAMES_DIR, { recursive: true });

  console.log('Opening page...');
  await agentBrowser('open', ['http://localhost:5173', '--headed']);

  // Test steps...

  console.log('Generating GIF...');
  await generateGif(FRAMES_DIR, `${OUTPUT_DIR}/${TEST_NAME}.gif`);

  console.log('Test completed!');
}

main().catch(console.error);
```

## 使用例

### 1. テスト計画を伝える

```
以下のテスト計画でmjsスクリプトを生成してください：

テスト名: タスク追加テスト
URL: http://localhost:5173
手順:
1. 初期状態をスクリーンショット
2. タイトル入力欄(@e5)をクリック
3. "買い物リスト"と入力
4. 説明欄(@e6)をクリック
5. "牛乳、卵、パン"と入力
6. 入力状態をスクリーンショット（入力欄をハイライト）
7. 追加ボタン(@e7)をクリック
8. 500ms待機
9. 結果をスクリーンショット
10. GIFを生成
```

### 2. 生成されるスクリプトを実行

```bash
node test-add-task.mjs
```

## テストアクション一覧

| アクション | 説明 | パラメータ |
|-----------|------|-----------|
| `open` | ページを開く | url, headed |
| `click` | 要素をクリック | target (ref) |
| `type` | テキストを入力 | target, text |
| `fill` | クリア後に入力 | target, text |
| `screenshot` | スクリーンショット | name, highlight?, zoom? |
| `wait` | 待機 | time (ms) |
| `snapshot` | 要素一覧取得 | - |
| `hover` | ホバー | target |
| `press` | キー押下 | key |

## スクリーンショットオプション

```javascript
// 基本のスクリーンショット
await screenshot('step-1');

// ハイライト付き（赤枠）
await screenshotWithHighlight('step-2', { x: 100, y: 200, width: 300, height: 50 });

// ズーム付き
await screenshotWithZoom('step-3', { x: 100, y: 200, width: 300, height: 50 }, 2);

// ハイライト + ズーム
await screenshotHighlightAndZoom('step-4', box, { scale: 1.5 });
```

## GIF生成オプション

```javascript
// 基本のGIF生成（3fps、ループ）
await generateGif(framesDir, 'output.gif');

// 高品質版（フルサイズ、高画質）
await generateGif(framesDir, 'output-hq.gif', {
  fps: 5,
  quality: 'high',
  scale: '1280:-1'
});
```

## Todo-App用のテスト計画テンプレート

### 1. タスク追加テスト
- 初期状態確認
- タイトル入力
- 説明入力（オプション）
- 追加ボタンクリック
- トースト表示確認
- タスクリスト更新確認

### 2. タスク完了トグルテスト
- 未完了タスクの確認
- チェックボックスクリック
- 完了状態の確認
- トースト表示確認

### 3. タスク編集テスト
- 編集ボタンクリック
- モーダル表示確認
- タイトル編集
- 保存ボタンクリック
- 更新確認

### 4. タスク削除テスト
- 削除ボタンクリック
- 確認モーダル表示
- 削除確認ボタンクリック
- タスク削除確認

### 5. フィルターテスト
- 「すべて」タブ確認
- 「未完了」タブクリック
- フィルター結果確認
- 「完了」タブクリック
- フィルター結果確認

### 6. 検索テスト
- 検索ボックスに入力
- 検索結果確認
- クリアして全件表示確認

## 出力ファイル構成

```
test-output/
├── add-task/
│   ├── frames/
│   │   ├── 001-initial.png
│   │   ├── 002-input.png
│   │   └── 003-result.png
│   ├── add-task.gif
│   └── add-task-hq.gif
├── toggle-task/
│   └── ...
└── ...
```

## GIF品質チェック機能

生成されたGIFとスクリーンショットの品質を検証し、問題があれば具体的に指摘します。

### チェック項目

| チェック項目 | 説明 | 重要度 |
|-------------|------|--------|
| フレーム数 | 期待されるフレーム数が含まれているか | 高 |
| ハイライト位置 | 赤枠が対象要素を正しく囲んでいるか | 高 |
| 要素の可視性 | ハイライト対象の要素が実際に表示されているか | 高 |
| フレーム順序 | フレームが正しい順序で並んでいるか | 中 |
| 画質 | GIFの画質が十分か | 低 |

### 問題検出パターン

#### パターン1: ホバー要素が表示されていない

**症状**: 赤枠は表示されているが、その中に対象要素（ボタンなど）が見えない

![問題例](画像: 赤枠だけが表示され、中にボタンがない)

**原因**: ホバー時のみ表示される要素（編集ボタン✎、削除ボタン✕など）に対して、ホバーせずにスクリーンショットを撮影

**解決策**:
```javascript
// スクリーンショット前にホバーを追加
const btnRef = findRef(snapshot, /button "✎" \[ref=(e\d+)\]/);
if (btnRef) {
  await agentBrowser('hover', [btnRef]);
  await sleep(300);  // 表示アニメーション待ち
}
// その後にスクリーンショット
await screenshotWithHighlight('button-highlight', btnBox, 'ボタン');
```

**確認方法**:
1. 問題のフレーム画像を開く
2. 赤枠の中に対象要素があるか確認
3. なければホバーを追加

#### パターン2: ハイライト位置がずれている

**症状**: 赤枠が対象要素から離れた位置に表示されている

**原因**:
- ハードコードされた座標を使用している
- 要素インデックスが変わっている
- ページレイアウトが変わった

**解決策**:
```javascript
// ❌ 悪い例: ハードコード座標
const box = { x: 860, y: 478, width: 95, height: 50 };

// ✅ 良い例: 動的に位置を取得
const result = await agentBrowser('eval', [
  `JSON.stringify(document.querySelectorAll('button')[${index}]?.getBoundingClientRect())`
]);
const box = parseEvalResult(result);
```

**確認方法**:
1. 赤枠と対象要素の位置関係を確認
2. 大きくずれている場合は座標取得方法を見直す

#### パターン3: フレームが欠落している

**症状**: GIFのフレーム数が期待より少ない、または一部のステップが抜けている

**確認方法**:
```bash
# フレームファイル数を確認
ls test-output/{test-name}-frames/*.png | grep -v raw | wc -l

# GIFのフレーム数を確認
ffprobe -v error -select_streams v:0 -count_frames \
  -show_entries stream=nb_read_frames -of csv=p=0 \
  test-output/{test-name}.gif
```

### Claudeによる品質チェックの依頼方法

以下のプロンプトでGIFの品質チェックを依頼できます：

#### 全体チェック
```
test-output/add-task.gif の品質をチェックしてください。
- 各フレームのハイライトが正しい位置にあるか
- 対象要素が見えているか
- 問題があれば具体的に教えてください
```

#### 個別フレームチェック
```
test-output/edit-task-frames/ のスクリーンショットを確認してください。
特に 002-02-edit-button.png の赤枠が正しい要素をハイライトしているか
チェックしてください。
```

#### 比較チェック
```
test-output/delete-task-frames/002-02-delete-button.png を確認して、
削除ボタン（✕）が赤枠内に見えているか教えてください。
見えていなければ修正方法も提案してください。
```

### 品質チェックワークフロー

1. **GIFを確認**
   ```
   test-output/{test-name}.gif を見せて
   ```

2. **問題がありそうなフレームを特定**
   ```
   {フレーム番号}番目のフレームがおかしいように見えます
   ```

3. **個別フレームを詳細確認**
   ```
   test-output/{test-name}-frames/{frame-file}.png を確認して
   赤枠内に対象要素が見えているかチェックしてください
   ```

4. **修正を適用**
   - ホバーが必要な場合: テストスクリプトにホバーを追加
   - 位置がずれている場合: 動的座標取得に変更

5. **テストを再実行してGIFを再生成**
   ```bash
   node tests/test-{name}.mjs
   ./scripts/generate-gif.sh test-output/{name}-frames test-output/{name}.gif 2
   ```

### チェックリスト

GIFをレビューする際の確認項目：

- [ ] 全てのフレームが含まれている
- [ ] 初期状態のフレームがある
- [ ] 最終状態（結果）のフレームがある
- [ ] ハイライトフレームで対象要素が見えている
- [ ] ハイライトの位置が正確
- [ ] 操作の流れが分かりやすい
- [ ] フレーム間の遷移が自然
